name: Codex CI Autofix (Reusable)

# This is a REUSABLE workflow that can be called from any repository in your organization
# Deploy this to your organization's .github repository

on:
  workflow_call:
    inputs:
      failed_workflow_id:
        description: 'ID of the failed workflow run'
        required: true
        type: string
      failed_workflow_name:
        description: 'Name of the failed workflow'
        required: true
        type: string
      head_branch:
        description: 'Branch where the failure occurred'
        required: true
        type: string
      head_sha:
        description: 'Commit SHA where the failure occurred'
        required: true
        type: string
      safety_strategy:
        description: 'Safety strategy (drop-sudo or read-only)'
        required: false
        default: 'drop-sudo'
        type: string
    secrets:
      OPENAI_API_KEY:
        required: true
      GITHUB_TOKEN:
        required: true

permissions:
  contents: write
  pull-requests: write
  actions: read
  checks: read

jobs:
  autofix:
    name: Auto-fix CI Failures with Codex
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.head_branch }}
          fetch-depth: 0

      - name: Install Codex and apply fixes
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: ${{ inputs.safety_strategy }}
        env:
          CODEX_CONTEXT: |
            The CI workflow failed. Please:
            1. Analyze the CI failure logs
            2. Identify the root cause
            3. Apply a minimal fix to resolve the failure
            4. Ensure the fix doesn't introduce new issues
            5. Run relevant tests to verify the fix

      - name: Get failed workflow logs
        run: |
          gh run view ${{ inputs.failed_workflow_id }} --log-failed > ci-failure-logs.txt || echo "Could not retrieve logs"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Codex to fix CI failures
        run: |
          codex exec "
Analyze the CI failure logs in ci-failure-logs.txt.

Failed Workflow: ${{ inputs.failed_workflow_name }}
Workflow ID: ${{ inputs.failed_workflow_id }}
Branch: ${{ inputs.head_branch }}
Commit: ${{ inputs.head_sha }}

Identify the root cause and apply a minimal fix.

Focus on:
- Build failures
- Test failures
- Linting errors
- Type errors
- Dependency issues

Make only the necessary changes to fix the failures.
Do not refactor or make unrelated changes.
Ensure backward compatibility.
"

      - name: Verify fixes
        id: verify
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "Files modified by Codex:"
            git status -s
          else
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "No changes made by Codex"
          fi

      - name: Create fix PR
        if: steps.verify.outputs.changes_made == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "Codex CI Autofix"
          git config --global user.email "codex-autofix@github-actions"

          FIX_BRANCH="codex-autofix-${{ inputs.failed_workflow_id }}"
          git checkout -b "$FIX_BRANCH"

          git add -A
          git commit -m "fix: Auto-fix CI failures detected in run ${{ inputs.failed_workflow_id }}

Automated fix generated by OpenAI Codex for CI failures.

Original workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ inputs.failed_workflow_id }}
Failed workflow: ${{ inputs.failed_workflow_name }}
Branch: ${{ inputs.head_branch }}
Commit: ${{ inputs.head_sha }}

Changes made:
$(git diff HEAD~1 --stat)

ü§ñ Generated by Codex CI Autofix (Organization-wide Reusable Workflow)
"

          git push origin "$FIX_BRANCH"

          gh pr create \
            --title "ü§ñ Codex CI Autofix: Fix failures from ${{ inputs.failed_workflow_name }}" \
            --body "## Automated CI Fix

This PR contains automated fixes for CI failures detected by Codex.

### Failed Workflow Details
- **Workflow:** ${{ inputs.failed_workflow_name }}
- **Run ID:** ${{ inputs.failed_workflow_id }}
- **Run URL:** https://github.com/${{ github.repository }}/actions/runs/${{ inputs.failed_workflow_id }}
- **Branch:** \`${{ inputs.head_branch }}\`
- **Commit:** \`${{ inputs.head_sha }}\`

### What Codex Fixed
Codex analyzed the CI failure logs and automatically applied fixes for:
- Build failures
- Test failures
- Linting errors
- Type errors
- Dependency issues

### Changes Made
\`\`\`
$(git diff HEAD~1 --stat)
\`\`\`

### Review Required
‚ö†Ô∏è **Please review these changes carefully before merging.**

While Codex applies minimal, targeted fixes, human review is essential to ensure:
- The fix addresses the root cause
- No unintended side effects are introduced
- The changes align with project standards

### Testing
The CI will run automatically on this PR. Please verify:
- [ ] All tests pass
- [ ] No new issues introduced
- [ ] Changes are minimal and focused

---
ü§ñ Generated by Codex CI Autofix (Organization-wide Reusable Workflow)
Powered by [openai/codex-action](https://github.com/openai/codex-action)
" \
            --base ${{ inputs.head_branch }} \
            --head "$FIX_BRANCH" \
            --label "codex-autofix" \
            --label "automated" \
            --label "ci-fix"

      - name: Upload failure logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-failure-logs-${{ inputs.failed_workflow_id }}
          path: ci-failure-logs.txt
          retention-days: 30
